name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build:
    name: Build
    runs-on: ${{ matrix.runner }}
    strategy:
      matrix:
        include:
          - goos: darwin
            goarch: amd64
            name: darwin-amd64
            runner: macos-latest
          - goos: darwin
            goarch: arm64
            name: darwin-arm64
            runner: macos-latest
          - goos: linux
            goarch: amd64
            name: linux-amd64
            runner: ubuntu-latest
          - goos: linux
            goarch: arm64
            name: linux-arm64
            runner: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod

      - name: Build
        env:
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
        run: |
          VERSION=${GITHUB_REF_NAME#v}
          go build -ldflags "-X main.version=${VERSION}" -o mdp ./cmd/mdp

      - name: Create archive
        run: |
          tar -czvf mdp-${{ matrix.name }}.tar.gz mdp

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: mdp-${{ matrix.name }}
          path: mdp-${{ matrix.name }}.tar.gz

  release:
    name: Release
    needs: build
    runs-on: ubuntu-latest
    outputs:
      sha256_darwin_amd64: ${{ steps.sha256.outputs.darwin_amd64 }}
      sha256_darwin_arm64: ${{ steps.sha256.outputs.darwin_arm64 }}
      sha256_linux_amd64: ${{ steps.sha256.outputs.linux_amd64 }}
      sha256_linux_arm64: ${{ steps.sha256.outputs.linux_arm64 }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: true

      - name: Calculate SHA256
        id: sha256
        run: |
          cd artifacts
          echo "darwin_amd64=$(sha256sum mdp-darwin-amd64.tar.gz | cut -d ' ' -f1)" >> $GITHUB_OUTPUT
          echo "darwin_arm64=$(sha256sum mdp-darwin-arm64.tar.gz | cut -d ' ' -f1)" >> $GITHUB_OUTPUT
          echo "linux_amd64=$(sha256sum mdp-linux-amd64.tar.gz | cut -d ' ' -f1)" >> $GITHUB_OUTPUT
          echo "linux_arm64=$(sha256sum mdp-linux-arm64.tar.gz | cut -d ' ' -f1)" >> $GITHUB_OUTPUT

      - name: Generate changelog
        uses: orhun/git-cliff-action@v4
        id: changelog
        with:
          config: cliff.toml
          args: --latest --strip header
        env:
          GITHUB_REPO: ${{ github.repository }}

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: artifacts/*.tar.gz
          body: ${{ steps.changelog.outputs.content }}

  update-homebrew:
    name: Update Homebrew Tap
    needs: release
    runs-on: ubuntu-latest
    steps:
      - name: Checkout homebrew-tap
        uses: actions/checkout@v4
        with:
          repository: sadiksaifi/homebrew-tap
          token: ${{ secrets.HOMEBREW_TAP_PAT }}
          path: homebrew-tap

      - name: Update formula
        env:
          VERSION: ${{ github.ref_name }}
          SHA256_AMD64: ${{ needs.release.outputs.sha256_darwin_amd64 }}
          SHA256_ARM64: ${{ needs.release.outputs.sha256_darwin_arm64 }}
        run: |
          VERSION_NUM=${VERSION#v}
          cat > homebrew-tap/Formula/mdp.rb << EOF
          class Mdp < Formula
            desc "A fast CLI tool that previews Markdown files in your browser with GitHub-styled rendering"
            homepage "https://github.com/sadiksaifi/mdp"
            version "${VERSION_NUM}"
            license "MIT"

            on_macos do
              if Hardware::CPU.arm?
                url "https://github.com/sadiksaifi/mdp/releases/download/${VERSION}/mdp-darwin-arm64.tar.gz"
                sha256 "${SHA256_ARM64}"
              else
                url "https://github.com/sadiksaifi/mdp/releases/download/${VERSION}/mdp-darwin-amd64.tar.gz"
                sha256 "${SHA256_AMD64}"
              end
            end

            def install
              bin.install "mdp"
            end

            test do
              system "#{bin}/mdp", "--help" rescue nil
            end
          end
          EOF

      - name: Commit and push
        working-directory: homebrew-tap
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add Formula/mdp.rb
          git commit -m "release: mdp version ${{ github.ref_name }}

          Release: https://github.com/sadiksaifi/mdp/releases/tag/${{ github.ref_name }}"
          git push
